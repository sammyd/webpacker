<%= shebang %>
$stdout.sync = true

require "shellwords"
require "yaml"
require "socket"

ENV["RAILS_ENV"] ||= ENV["RACK_ENV"] || "development"
RAILS_ENV = ENV["RAILS_ENV"]

ENV["NODE_ENV"] ||= RAILS_ENV
NODE_ENV = ENV["NODE_ENV"]

APP_PATH          = File.expand_path("../", __dir__)
CONFIG_FILE       = File.join(APP_PATH, "config/webpacker.yml")
NODE_MODULES_PATH = File.join(APP_PATH, "node_modules")
WEBPACK_CONFIG    = File.join(APP_PATH, "config/webpack/#{NODE_ENV}.js")

begin
  dev_server = YAML.load_file(CONFIG_FILE)[RAILS_ENV]["dev_server"]
  HOSTNAME          = dev_server["host"]
  PORT              = dev_server["port"]

rescue Errno::ENOENT, NoMethodError
  $stdout.puts "Webpack dev_server configuration not found in #{CONFIG_FILE}."
  $stdout.puts "Please run bundle exec rails webpacker:install to install webpacker"
  exit!
end

begin
  server = TCPServer.new(HOSTNAME, PORT)
  server.close

rescue Errno::EADDRINUSE
  $stdout.puts "Another program is running on port #{PORT}. Set a new port in #{CONFIG_FILE} for dev_server"
  exit!
end

env = { "NODE_PATH" => NODE_MODULES_PATH.shellescape }

cmd = [
  "#{NODE_MODULES_PATH}/.bin/webpack-dev-server",
  "--progress",
  "--color",
  "--config", WEBPACK_CONFIG
]

Dir.chdir(APP_PATH) do
  exec env, *cmd
end
